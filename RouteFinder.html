<!DOCTYPE html>
<html>
<head>
    <title>WeBraining RouteFinder Pro</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        :root {
            --primary-color: #107c41;
            --secondary-color: #0a4b2a;
            --accent-color: #ff6b6b;
            --light-color: #f0f7f4;
            --dark-color: #2d3e50;
            --success-color: #107c41;
            --warning-color: #f39c12;
            --info-color: #3498db;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f9f9f9;
            color: #333;
            line-height: 1.6;
            padding: 0;
            margin: 0;
        }
        
        .app-container {
            max-width: 100%;
            margin: 0 auto;
            padding: 15px;
            background: white;
            min-height: 100vh;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }
        
        .app-header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 20px 15px;
            margin: -15px -15px 20px -15px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            position: relative;
        }
        
        .app-title {
            font-size: 24px;
            font-weight: 700;
            letter-spacing: 1px;
            margin-bottom: 5px;
        }
        
        .app-subtitle {
            font-size: 14px;
            opacity: 0.9;
            font-weight: 300;
        }
        
        .search-row {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
            margin-bottom: 15px;
            background: var(--light-color);
            padding: 15px;
            border-radius: 8px;
        }
        
        .search-group {
            display: flex;
            align-items: center;
            flex-grow: 1;
            min-width: 250px;
        }
        
        .search-group label {
            font-weight: 600;
            margin-right: 10px;
            color: var(--dark-color);
            white-space: nowrap;
        }
        
        .search-group input, 
        .search-group select {
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            flex-grow: 1;
            min-width: 100px;
        }
        
        .action-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .filter-row {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
            background: #f5f5f5;
            padding: 10px;
            border-radius: 8px;
            align-items: center;
        }
        
        .active-filters {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-left: 10px;
            align-items: center;
        }
        
        .filter-tag {
            background-color: #e0e0e0;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .filter-tag button {
            background: none;
            border: none;
            color: #666;
            cursor: pointer;
            font-size: 12px;
            padding: 0;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        
        .btn:active {
            transform: scale(0.98);
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #0a4b2a;
            transform: translateY(-2px);
        }
        
        .btn-primary:active {
            transform: translateY(0) scale(0.98);
        }
        
        .btn-success {
            background-color: var(--success-color);
            color: white;
        }
        
        .btn-success:hover {
            background-color: #0a4b2a;
            transform: translateY(-2px);
        }
        
        .btn-warning {
            background-color: var(--warning-color);
            color: white;
        }
        
        .btn-warning:hover {
            background-color: #e67e22;
            transform: translateY(-2px);
        }
        
        .btn-info {
            background-color: var(--info-color);
            color: white;
        }
        
        .btn-info:hover {
            background-color: #2980b9;
            transform: translateY(-2px);
        }
        
        .btn-danger {
            background-color: #e74c3c;
            color: white;
        }
        
        .btn-danger:hover {
            background-color: #c0392b;
            transform: translateY(-2px);
        }
        
        .btn-secondary {
            background-color: #95a5a6;
            color: white;
        }
        
        .btn-secondary:hover {
            background-color: #7f8c8d;
            transform: translateY(-2px);
        }
        
        .status-container {
            flex-grow: 1;
            margin: 0 10px;
            min-width: 200px;
        }
        
        .status-text {
            font-size: 13px;
            color: #7f8c8d;
            font-style: italic;
            margin-bottom: 5px;
        }
        
        .progress-container {
            width: 100%;
            height: 6px;
            background-color: #ecf0f1;
            border-radius: 3px;
            overflow: hidden;
        }
        
        .progress-bar {
            height: 100%;
            background-color: var(--success-color);
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .language-selector {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .language-btn {
            padding: 5px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 13px;
            font-weight: 600;
        }
        
        .language-btn:hover {
            background-color: #f0f0f0;
        }
        
        .language-btn.active {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--secondary-color);
        }
        
        .modal-textarea {
            width: 100%;
            height: 200px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: monospace;
            margin-bottom: 15px;
            resize: vertical;
        }
        
        .modal-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        
        .results-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            overflow: hidden;
            border-radius: 8px;
        }
        
        .results-table th {
            background-color: var(--secondary-color);
            color: white;
            padding: 12px 15px;
            text-align: left;
            font-weight: 600;
            position: sticky;
            top: 0;
        }
        
        .results-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
        }
        
        .results-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        
        .results-table tr:hover {
            background-color: #f1f1f1;
        }
        
        .no-results {
            text-align: center;
            padding: 30px;
            color: var(--accent-color);
            font-weight: 500;
        }
        
        #customRadius {
            width: 80px;
            margin-left: 10px;
            display: none;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
        }
        
        .file-format-info {
            background-color: #f8f9fa;
            border-left: 4px solid var(--info-color);
            padding: 15px;
            margin: 15px 0;
            font-size: 14px;
        }
        
        .file-format-info h4 {
            margin-top: 0;
            color: var(--info-color);
        }
        
        .file-format-info ul {
            padding-left: 20px;
            margin-bottom: 0;
        }
        
        .active-filter {
            position: relative;
            overflow: hidden;
        }
        
        .active-filter::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background-color: white;
        }
        
        .pagination {
            display: flex;
            justify-content: center;
            margin-top: 20px;
            gap: 5px;
        }
        
        .page-btn {
            padding: 8px 12px;
            border: 1px solid #ddd;
            background-color: white;
            cursor: pointer;
            border-radius: 4px;
        }
        
        .page-btn.active {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        
        @media (max-width: 768px) {
            .search-group {
                min-width: 100%;
            }
            
            .btn {
                flex-grow: 1;
            }
            
            .action-row {
                flex-direction: column;
                align-items: stretch;
            }
            
            .status-container {
                margin: 10px 0;
                order: 3;
            }
            
            .results-table {
                font-size: 14px;
            }
            
            .results-table th, 
            .results-table td {
                padding: 8px 10px;
            }
            
            .filter-row {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .active-filters {
                margin-left: 0;
                margin-top: 10px;
                width: 100%;
            }
        }
        
        @media (max-width: 480px) {
            .app-title {
                font-size: 20px;
            }
            
            .search-group label {
                font-size: 14px;
            }
            
            .results-table {
                display: block;
                overflow-x: auto;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="app-header">
            <div class="app-title">WeBraining RouteFinder Pro</div>
            <div class="app-subtitle" data-lang="tr">Almanya Posta Kodu Mesafe Analiz Uygulaması</div>
            <div class="app-subtitle" data-lang="de" style="display:none;">Deutsche Postleitzahl Entfernungsanalyse</div>
            <div class="app-subtitle" data-lang="en" style="display:none;">Germany Postal Code Distance Analysis</div>
        </div>
        
        <div class="search-row">
            <div class="search-group">
                <label for="centerInput" data-lang="tr">Merkez PLZ:</label>
                <label for="centerInput" data-lang="de" style="display:none;">Zentrale PLZ:</label>
                <label for="centerInput" data-lang="en" style="display:none;">Center PLZ:</label>
                <input type="text" id="centerInput" placeholder="Örnek: 1099" value="10115" 
                    data-placeholder-tr="Örnek: 1099" 
                    data-placeholder-de="Beispiel: 1099" 
                    data-placeholder-en="Example: 1099">
            </div>
            
            <div class="search-group">
                <label for="radiusKm" data-lang="tr">Yarıçap:</label>
                <label for="radiusKm" data-lang="de" style="display:none;">Radius:</label>
                <label for="radiusKm" data-lang="en" style="display:none;">Radius:</label>
                <select id="radiusKm" onchange="checkCustomRadius()">
                    <option value="0.5">0.5 km</option>
                    <option value="1">1 km</option>
                    <option value="2">2 km</option>
                    <option value="3">3 km</option>
                    <option value="5" selected>5 km</option>
                    <option value="7">7 km</option>
                    <option value="10">10 km</option>
                    <option value="15">15 km</option>
                    <option value="20">20 km</option>
                    <option value="30">30 km</option>
                    <option value="50">50 km</option>
                    <option value="75">75 km</option>
                    <option value="100">100 km</option>
                    <option value="custom" data-value-tr="Özel" data-value-de="Benutzerdefiniert" data-value-en="Custom">Özel</option>
                </select>
                <input type="number" id="customRadius" placeholder="KM" 
                    data-placeholder-tr="KM" 
                    data-placeholder-de="KM" 
                    data-placeholder-en="KM">
            </div>
        </div>
        
        <div class="action-row">
            <button class="btn btn-primary" onclick="searchData()" data-lang="tr">Ara</button>
            <button class="btn btn-primary" onclick="searchData()" data-lang="de" style="display:none;">Suchen</button>
            <button class="btn btn-primary" onclick="searchData()" data-lang="en" style="display:none;">Search</button>
            
            <button class="btn btn-warning" onclick="openFileModal()" data-lang="tr">Excel/CSV Yükle</button>
            <button class="btn btn-warning" onclick="openFileModal()" data-lang="de" style="display:none;">Excel/CSV Laden</button>
            <button class="btn btn-warning" onclick="openFileModal()" data-lang="en" style="display:none;">Load Excel/CSV</button>
            
            <div class="status-container">
                <div class="status-text" id="statusText" data-lang="tr">Hazır</div>
                <div class="status-text" id="statusText" data-lang="de" style="display:none;">Bereit</div>
                <div class="status-text" id="statusText" data-lang="en" style="display:none;">Ready</div>
                <div class="progress-container">
                    <div class="progress-bar" id="progressBar"></div>
                </div>
            </div>
            
            <div class="language-selector">
                <button class="language-btn active" id="lang-tr" onclick="changeLanguage('tr')">TR</button>
                <button class="language-btn" id="lang-de" onclick="changeLanguage('de')">DE</button>
                <button class="language-btn" id="lang-en" onclick="changeLanguage('en')">EN</button>
            </div>
            
            <button class="btn btn-success" onclick="exportToExcel()" data-lang="tr">Excel'e Aktar</button>
            <button class="btn btn-success" onclick="exportToExcel()" data-lang="de" style="display:none;">Zu Excel</button>
            <button class="btn btn-success" onclick="exportToExcel()" data-lang="en" style="display:none;">Export Excel</button>
        </div>
        
        <div class="filter-row">
            <button class="btn btn-success" id="filterBigCities" onclick="toggleFilter('bigCities')" data-lang="tr">Büyük Şehirleri Filtrele</button>
            <button class="btn btn-success" id="filterBigCities" onclick="toggleFilter('bigCities')" data-lang="de" style="display:none;">Großstädte filtern</button>
            <button class="btn btn-success" id="filterBigCities" onclick="toggleFilter('bigCities')" data-lang="en" style="display:none;">Filter Big Cities</button>
            
            <button class="btn btn-success" id="filterMediumCities" onclick="toggleFilter('mediumCities')" data-lang="tr">Orta Şehirleri Filtrele</button>
            <button class="btn btn-success" id="filterMediumCities" onclick="toggleFilter('mediumCities')" data-lang="de" style="display:none;">Mittelgroße Städte filtern</button>
            <button class="btn btn-success" id="filterMediumCities" onclick="toggleFilter('mediumCities')" data-lang="en" style="display:none;">Filter Medium Cities</button>
            
            <button class="btn btn-success" id="filterSmallCities" onclick="toggleFilter('smallCities')" data-lang="tr">Küçük Şehirleri Filtrele</button>
            <button class="btn btn-success" id="filterSmallCities" onclick="toggleFilter('smallCities')" data-lang="de" style="display:none;">Kleinstädte filtern</button>
            <button class="btn btn-success" id="filterSmallCities" onclick="toggleFilter('smallCities')" data-lang="en" style="display:none;">Filter Small Cities</button>
            
            <button class="btn btn-success" id="filterLandline" onclick="toggleFilter('landline')" data-lang="tr">Cep Numaralarını Gizle</button>
            <button class="btn btn-success" id="filterLandline" onclick="toggleFilter('landline')" data-lang="de" style="display:none;">Handys ausblenden</button>
            <button class="btn btn-success" id="filterLandline" onclick="toggleFilter('landline')" data-lang="en" style="display:none;">Hide Mobile</button>
            
            <button class="btn btn-success" id="filterMobile" onclick="toggleFilter('mobile')" data-lang="tr">Sabit Hatları Gizle</button>
            <button class="btn btn-success" id="filterMobile" onclick="toggleFilter('mobile')" data-lang="de" style="display:none;">Festnetz ausblenden</button>
            <button class="btn btn-success" id="filterMobile" onclick="toggleFilter('mobile')" data-lang="en" style="display:none;">Hide Landline</button>
            
            <div class="active-filters" id="activeFilters"></div>
        </div>
        
        <table class="results-table" id="resultsTable">
            <thead>
                <tr id="tableHeaderRow"></tr>
            </thead>
            <tbody id="resultsBody"></tbody>
        </table>
        
        <div class="pagination" id="pagination"></div>
    </div>

    <!-- Dosya Yükleme Modalı -->
    <div class="modal" id="fileModal">
        <div class="modal-content">
            <div class="modal-title" data-lang="tr">Excel veya CSV Verilerini Yükle</div>
            <div class="modal-title" data-lang="de" style="display:none;">Excel oder CSV-Daten laden</div>
            <div class="modal-title" data-lang="en" style="display:none;">Load Excel or CSV Data</div>
            
            <div class="file-format-info">
                <h4 data-lang="tr">Dosya Formatı Talimatları</h4>
                <h4 data-lang="de" style="display:none;">Dateiformatanleitung</h4>
                <h4 data-lang="en" style="display:none;">File Format Instructions</h4>
                
                <div data-lang="tr">
                    <p>Excel/CSV dosyanızın ilk 5 sütunu şu şekilde olmalıdır (sırayla):</p>
                    <ol>
                        <li><strong>Ad Soyad</strong></li>
                        <li><strong>Telefon</strong></li>
                        <li><strong>Adres</strong></li>
                        <li><strong>Posta Kodu (PLZ)</strong></li>
                        <li><strong>Şehir</strong></li>
                    </ol>
                    <p>5. sütundan sonra ekstra sütunlar varsa (yaş, email vb.), bu sütunların başlıkları kendi isimleriyle gösterilecektir.</p>
                </div>
                
                <div data-lang="de" style="display:none;">
                    <p>Die ersten 5 Spalten Ihrer Excel/CSV-Datei sollten wie folgt aussehen (in dieser Reihenfolge):</p>
                    <ol>
                        <li><strong>Name</strong></li>
                        <li><strong>Telefon</strong></li>
                        <li><strong>Adresse</strong></li>
                        <li><strong>Postleitzahl (PLZ)</strong></li>
                        <li><strong>Stadt</strong></li>
                    </ol>
                    <p>Wenn es nach der 5. Spalte zusätzliche Spalten gibt (Alter, E-Mail usw.), werden diese Spalten mit ihren eigenen Überschriften angezeigt.</p>
                </div>
                
                <div data-lang="en" style="display:none;">
                    <p>The first 5 columns of your Excel/CSV file should be as follows (in order):</p>
                    <ol>
                        <li><strong>Name</strong></li>
                        <li><strong>Phone</strong></li>
                        <li><strong>Address</strong></li>
                        <li><strong>Postal Code (PLZ)</strong></li>
                        <li><strong>City</strong></li>
                    </ol>
                    <p>If there are extra columns after the 5th column (age, email, etc.), these columns will be displayed with their own headers.</p>
                </div>
            </div>
            
            <div style="margin-bottom: 15px;">
                <input type="file" id="fileInput" accept=".csv, .xlsx, .xls" style="display: none;">
                <button class="btn btn-primary" onclick="document.getElementById('fileInput').click()" data-lang="tr">Dosya Seç</button>
                <button class="btn btn-primary" onclick="document.getElementById('fileInput').click()" data-lang="de" style="display:none;">Datei auswählen</button>
                <button class="btn btn-primary" onclick="document.getElementById('fileInput').click()" data-lang="en" style="display:none;">Choose File</button>
                <span id="fileName" style="margin-left: 10px;"></span>
            </div>
            
            <div class="modal-buttons">
                <button class="btn btn-primary" onclick="loadFileData()" data-lang="tr">Yükle</button>
                <button class="btn btn-primary" onclick="loadFileData()" data-lang="de" style="display:none;">Laden</button>
                <button class="btn btn-primary" onclick="loadFileData()" data-lang="en" style="display:none;">Load</button>
                
                <button class="btn" onclick="closeFileModal()" data-lang="tr">İptal</button>
                <button class="btn" onclick="closeFileModal()" data-lang="de" style="display:none;">Abbrechen</button>
                <button class="btn" onclick="closeFileModal()" data-lang="en" style="display:none;">Cancel</button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        // 1. BAŞLANGIÇ VERİLERİ (Örnek)
        let csvData = `
Name_Vorname;Tel;Straße;PLZ;Ort
Mario Franceschi;491713373629;Arndtstr.6;10115;Berlin
Reiko Rölke;491747693590;Rotkehlchenweg 24;10117;Berlin
Heiko Kießlich;4915208906513;Ludwig-Kossuth Straße 46b;10119;Berlin
Frank Socha;49172 6442110;Am Trobischberg 13a;10178;Berlin
Hermann Schmidt;491721350086;Selliner Str. 8;10179;Berlin
Splitt;491635454292;;10243;Berlin
Udo Schoenfeld;49172 2070333;Sonnenleite 1;10245;Berlin
Peter Galle;491723774902;Pfaffengrund 6;10247;Berlin
Claudia Lommatzsch;49176 96399651;Stadtweg 21;10249;Berlin
Wilfried Panitz;49163 6413034;Reichenbachstr. 62;10315;Berlin
`.trim();

        // 2. UYGULAMA KODU
        let addressData = [];
        let currentResults = [];
        let currentLanguage = 'tr';
        let coordinateCache = {};
        let activeFilters = {
            bigCities: false,
            mediumCities: false,
            smallCities: false,
            landline: false,
            mobile: false
        };
        let extraColumns = [];
        let currentPage = 1;
        const resultsPerPage = 5000;
        
        // Almanya'daki büyük şehirlerin listesi
        const bigCities = [
            "Berlin", "Hamburg", "München", "Köln", "Frankfurt am Main", 
            "Düsseldorf", "Stuttgart", "Leipzig", "Dortmund", "Bremen", 
            "Essen", "Dresden", "Nürnberg", "Hannover", "Duisburg", 
            "Bochum", "Wuppertal", "Bielefeld", "Bonn", "Mannheim", 
            "Karlsruhe", "Münster", "Augsburg", "Wiesbaden", "Gelsenkirchen",
            "Mönchengladbach", "Aachen", "Braunschweig", "Kiel", "Chemnitz", 
            "Magdeburg", "Freiburg im Breisgau", "Krefeld", "Halle (Saale)", 
            "Mainz", "Erfurt", "Lübeck", "Oberhausen", "Rostock", "Kassel", 
            "Hagen", "Potsdam", "Saarbrücken", "Hamm", "Ludwigshafen am Rhein", 
            "Oldenburg", "Mülheim an der Ruhr", "Leverkusen", "Darmstadt", 
            "Osnabrück", "Solingen", "Paderborn", "Herne", "Heidelberg", 
            "Neuss", "Regensburg", "Ingolstadt", "Pforzheim", "Würzburg", 
            "Offenbach am Main", "Fürth", "Heilbronn", "Ulm", "Wolfsburg", 
            "Göttingen", "Reutlingen", "Bremerhaven", "Bottrop", "Erlangen", 
            "Recklinghausen", "Remscheid", "Koblenz", "Bergisch Gladbach", 
            "Jena", "Salzgitter", "Trier", "Siegen", "Moers", "Gütersloh", 
            "Kaiserslautern"
        ];

        // Orta boyutlu şehirler
        const mediumCities = [
            "Hildesheim", "Schwerin", "Hanau", "Flensburg", "Esslingen am Neckar", 
            "Gera", "Cottbus", "Düren", "Ludwigsburg", "Tübingen", 
            "Iserlohn", "Witten", "Villingen-Schwenningen", "Ratingen", "Gießen", 
            "Zwickau", "Konstanz", "Marl", "Worms", "Lünen", 
            "Minden", "Norderstedt", "Velbert", "Delmenhorst", "Neumünster", 
            "Viersen", "Rheine", "Bamberg", "Troisdorf", "Wilhelmshaven", 
            "Gladbeck", "Dessau-Roßlau", "Dorsten", "Arnsberg", "Lüneburg", 
            "Detmold", "Brandenburg an der Havel", "Marburg", "Castrop-Rauxel", "Bocholt", 
            "Aschaffenburg", "Bayreuth", "Landshut", "Lüdenscheid", "Lippstadt", 
            "Kempten (Allgäu)", "Aalen", "Herford", "Dinslaken", "Celle", 
            "Kerpen", "Neuwied", "Grevenbroich", "Weimar", "Rüsselsheim am Main", 
            "Plauen", "Fulda", "Rosenheim", "Schwäbisch Gmünd", "Dormagen", 
            "Offenburg", "Friedrichshafen", "Neu-Ulm", "Hürth", "Bergheim", 
            "Sindelfingen", "Herten", "Wesel", "Neubrandenburg", "Euskirchen", 
            "Langenfeld (Rheinland)", "Garbsen", "Göppingen", "Unna", "Hameln", 
            "Stolberg (Rheinland)", "Eschweiler", "Waiblingen", "Frankfurt (Oder)", "Meerbusch", 
            "Nordhorn", "Baden-Baden", "Bad Homburg vor der Höhe", "Sankt Augustin", "Lingen (Ems)", 
            "Pulheim", "Greifswald", "Görlitz", "Hilden", "Wetzlar", 
            "Schweinfurt", "Langenhagen", "Stralsund", "Bad Salzuflen", "Hattingen", 
            "Passau", "Kleve", "Bad Kreuznach", "Neustadt an der Weinstraße", "Ahlen", 
            "Wolfenbüttel", "Frechen", "Menden (Sauerland)", "Ibbenbüren", "Böblingen", 
            "Lörrach", "Elmshorn", "Gummersbach", "Peine", "Lahr/Schwarzwald", 
            "Rastatt", "Ravensburg", "Bad Oeynhausen", "Heidenheim an der Brenz", "Gronau (Westf.)"
        ];

        // Küçük şehirler
        const smallCities = [
            "Cuxhaven", "Speyer", "Leonberg", "Willich", "Emden", 
            "Bergkamen", "Oranienburg", "Straubing", "Freising", "Alsdorf", 
            "Erftstadt", "Stade", "Herzogenrath", "Landau in der Pfalz", "Bornheim", 
            "Hennef (Sieg)", "Frankenthal (Pfalz)", "Rheda-Wiedenbrück", "Dülmen", "Bruchsal", 
            "Soest", "Singen (Hohentwiel)", "Goslar", "Neunkirchen", "Dachau", 
            "Fellbach", "Albstadt", "Hof", "Oberursel (Taunus)", "Melle", 
            "Gotha", "Bünde", "Filderstadt", "Kaufbeuren", "Weinheim", 
            "Schwerte", "Falkensee", "Rottenburg am Neckar", "Brühl", "Erkelenz", 
            "Rodgau", "Lutherstadt Wittenberg", "Pinneberg", "Neustadt am Rübenberge", "Bernau bei Berlin", 
            "Lehrte", "Memmingen", "Seevetal", "Erkrath", "Monheim am Rhein", 
            "Bietigheim-Bissingen", "Homburg", "Wismar", "Kaarst", "Heinsberg", 
            "Borken", "Gifhorn", "Aurich", "Schwäbisch Hall", "Amberg", 
            "Siegburg", "Weiden in der Oberpfalz", "Kamen", "Kirchheim unter Teck", "Nettetal", 
            "Laatzen", "Buchholz in der Nordheide", "Dreieich", "Schorndorf", "Freiberg", 
            "Eberswalde", "Wunstorf", "Hückelhoven", "Leinfelden-Echterdingen", "Bensheim", 
            "Neumarkt in der Oberpfalz", "Coburg", "Völklingen", "Germering", "Buxtehude", 
            "Schwabach", "Löhne", "Nürtingen", "Nordhausen", "Eisenach", 
            "Ansbach", "Königswinter", "Ahaus", "Würselen", "Pirna", 
            "Lemgo", "Ostfildern", "Pirmasens", "Kehl", "Mettmann", 
            "Königs Wusterhausen", "Freital", "Hofheim am Taunus", "Maintal", "Ilmenau", 
            "Backnang", "Langen", "Ettlingen", "Niederkassel", "Coesfeld", 
            "Kamp-Lintfort", "Greven", "Haltern am See", "Wesseling", "Weißenfels", 
            "Neu-Isenburg", "Halberstadt", "Stendal", "Warendorf", "Saarlouis", 
            "Bautzen", "Fürstenfeldbruck", "Papenburg", "Erding", "Beckum", 
            "Tuttlingen", "Sinsheim", "Winsen (Luhe)", "Meppen", "Bitterfeld-Wolfen", 
            "Cloppenburg", "Porta Westfalica", "Ingelheim am Rhein", "Mühlhausen/Thüringen", "Emsdetten", 
            "Bad Vilbel", "Limburg an der Lahn", "Crailsheim", "Voerde (Niederrhein)", "Balingen", 
            "Dietzenbach", "Datteln", "St. Ingbert", "Lage", "Deggendorf", 
            "Hemer", "Geldern", "Wedel", "Goch", "Jülich", 
            "Steinfurt", "Suhl", "Rheinfelden (Baden)", "Korschenbroich", "Biberach an der Riß", 
            "Ahrensburg", "Viernheim", "Merseburg", "Wermelskirchen", "Seelze", 
            "Herrenberg", "Kempen", "Leer", "Kornwestheim", "Barsinghausen", 
            "Stuhr", "Vechta", "Schwedt/Oder", "Geesthacht", "Zweibrücken", 
            "Forchheim", "Radebeul", "Bad Nauheim", "Achim", "Uelzen", 
            "Itzehoe", "Nienburg/Weser", "Lampertheim", "Weil am Rhein", "Wernigerode", 
            "Delbrück", "Fürstenwalde/Spree", "Neuruppin", "Naumburg (Saale)", "Emmerich am Rhein", 
            "Radolfzell am Bodensee", "Merzig", "Mörfelden-Walldorf", "Ganderkesee", "Oer-Erkenschwick", 
            "Georgsmarienhütte", "Rheinberg", "Altenburg", "Geestland", "Burgdorf", 
            "Walsrode", "Bernburg (Saale)", "Lohmar", "Weyhe", "Kreuztal", 
            "Bad Hersfeld", "Hoyerswerda", "Rendsburg", "Schönebeck", "Friedberg (Hessen)", 
            "Andernach", "Bretten", "Werne", "Taunusstein", "Neuburg an der Donau", 
            "Oelde", "Haan", "Rietberg", "Gevelsberg", "Friedberg", 
            "Schwandorf", "Winnenden", "Wedemark", "Einbeck", "Osterholz-Scharmbeck", 
            "Bad Zwischenahn", "Meschede", "Werl", "Gaggenau", "Ludwigsfelde", 
            "Emmendingen", "Ennepetal", "Riesa", "Griesheim", "Landsberg am Lech", 
            "Tönisvorst", "Baesweiler", "Mühlheim am Main", "Mechernich", "Waltrop", 
            "Idar-Oberstein", "Blankenfelde-Mahlow", "Saalfeld/Saale", "Güstrow", "Vaihingen an der Enz", 
            "Meißen", "Rödermark", "Rösrath", "Springe", "Arnstadt", 
            "Bühl", "Geilenkirchen", "Unterschleißheim", "Hattersheim am Main", "Wangen im Allgäu", 
            "Zeitz", "Henstedt-Ulzburg", "Garmisch-Partenkirchen", "Kevelaer", "Reinbek", 
            "Bramsche", "Kelkheim (Taunus)", "Höxter", "Lohne (Oldenburg)", "Wegberg", 
            "Leichlingen (Rheinland)", "Schwelm", "Baunatal", "Königsbrunn", "Heppenheim (Bergstraße)", 
            "Geislingen an der Steige", "Ehingen (Donau)", "Wiesloch", "Strausberg", "Teltow", 
            "Sundern (Sauerland)", "Bad Neuenahr-Ahrweiler", "Grimma", "Northeim", "Olching", 
            "Neukirchen-Vluyn", "Verden (Aller)", "Weinstadt", "Werder (Havel)", "Butzbach", 
            "Pfaffenhofen an der Ilm", "Rheinbach", "Leimen", "Hamminkeln", "Hohen Neuendorf", 
            "Lübbecke", "Mühlacker", "Achern", "Hennigsdorf", "Overath", 
            "Kulmbach", "Weiterstadt", "Unterhaching", "Neckarsulm", "Bingen am Rhein", 
            "Schloß Holte-Stukenbrock", "Heiligenhaus", "Zirndorf", "Remseck am Neckar", "Lauf an der Pegnitz", 
            "Wetter (Ruhr)", "Geretsried", "Selm", "Delitzsch", "Nordenham", 
            "Friedrichsdorf", "Lindau (Bodensee)", "Verl", "Waldkraiburg", "Idstein", 
            "Öhringen", "Horb am Neckar", "Aschersleben", "Rinteln", "Espelkamp", 
            "Harsewinkel", "Roth", "St. Wendel", "Salzkotten", "Brilon", 
            "Pfungstadt", "Sangerhausen", "Groß-Gerau", "Schleswig", "Petershagen", 
            "Markkleeberg", "Obertshausen", "Bedburg", "Zittau", "Syke", 
            "Lüdinghausen", "Stutensee", "Norden", "Wiehl", "Helmstedt", 
            "Rathenow", "Bad Honnef", "Waldshut-Tiengen", "Meiningen", "Calw", 
            "Ellwangen (Jagst)", "Warstein", "Rottweil", "Vaterstetten", "Weingarten", 
            "Meckenheim", "Rudolstadt", "Bad Oldesloe", "Schmallenberg", "Varel", 
            "Eisenhüttenstadt", "Olpe", "Wandlitz", "Starnberg", "Freudenstadt", 
            "Mosbach", "Plettenberg", "Haren (Ems)", "Übach-Palenberg", 
            "Lennestadt", "Herzogenaurach", "Sprockhövel", "Leutkirch im Allgäu", "Köthen (Anhalt)", 
            "Husum", "Isernhagen", "Bad Mergentheim", "Westerstede", "Jüchen", 
            "Nagold", "Döbeln", "Ronnenberg", "Alfter", "Limbach-Oberfrohna", 
            "Senden", "Attendorn", "Neu Wulmstorf", "Kaltenkirchen", "Hann.Münden", 
            "Senftenberg", "Sehnde", "Gersthofen", "Moormerland", "Gelnhausen", 
            "Weilheim in Oberbayern", "Warburg", "Bad Kissingen", "Staßfurt", "Metzingen", 
            "Riedstadt", "Quedlinburg", "Rotenburg (Wümme)", "Bad Soden am Taunus", "Vreden", 
            "Netphen", "Dillenburg", "Salzwedel", "Kitzingen", "Neusäß", 
            "Korbach", "Rastede", "Haar", "Wertheim", "Sonneberg", 
            "Laupheim", "Ottobrunn", "Apolda", "Herdecke", "Überlingen", 
            "Bad Rappenau", "Friesoythe", "Ditzingen", "Eppingen", "Stadthagen", 
            "Edewecht", "Wallenhorst", "Karben", "Burg", "Bad Salzungen", 
            "Lengerich", "Quickborn", "Soltau", "Lutherstadt Eisleben", "Mühldorf am Inn", 
            "Waghäusel", "Büdingen", "Eschborn", "Eislingen/Fils", "Aichach", 
            "Heide", "Rees", "Gauting", "Gardelegen", "Donaueschingen", 
            "Zülpich", "Schwetzingen", "Bad Krozingen", "Mössingen", "Sonthofen", 
            "Hockenheim", "Lindlar", "Wipperfürth", "Osterode am Harz", "Büren", 
            "Radevormwald", "Eckernförde", "Dillingen/Saar", "Versmold", "Waldkirch", 
            "Ilsede", "Glauchau", "Stadtallendorf", "Elsdorf", "Günzburg", 
            "Zossen", "Karlsfeld", "Halle (Westf.)", "Flörsheim am Main", "Seligenstadt", 
            "Germersheim", "Rheinstetten", "Groß-Umstadt", "Xanten", "Wildeshausen", 
            "Panketal", "Spremberg", "Westoverledingen", "Zerbst/Anhalt", "Neufahrn bei Freising", 
            "Luckenwalde", "Schortens", "Stadtlohn", "Geseke", "Sondershausen", 
            "Traunstein", "Puchheim", "Senden", "Bad Waldsee", "Dingolfing", 
            "Wülfrath", "Enger", "Schifferstadt", "Schramberg", "Werdau", 
            "Tettnang", "Bruchköbel", "Fröndenberg/Ruhr", "Lichtenfels", "Coswig", 
            "Wachtberg", "Haßloch", "Herborn", "Ochtrup", "Burgwedel", 
            "Traunreut", "Duderstadt", "Nördlingen", "Schopfheim", "Steinhagen", 
            "Neunkirchen-Seelscheid", "Waren (Müritz)", "Nottuln", "Blieskastel", "Neustrelitz", 
            "Hörstel", "Lilienthal", "Borna", "Nidderau", 
            "Müllheim im Markgräflerland", "Telgte", "Uetze", "Wilnsdorf", "Wittmund", 
            "Kürten", "Meinerzhagen", "Moosburg an der Isar"
        ];

        // Dil değiştirme fonksiyonu
        function changeLanguage(lang) {
            currentLanguage = lang;
            
            // Dil butonlarını güncelle
            document.querySelectorAll('.language-btn').forEach(btn => {
                btn.classList.toggle('active', btn.id === `lang-${lang}`);
            });
            
            // Tüm dil öğelerini güncelle
            document.querySelectorAll('[data-lang]').forEach(el => {
                el.style.display = el.dataset.lang === lang ? '' : 'none';
            });
            
            // Placeholder'ları güncelle
            document.getElementById('centerInput').placeholder = 
                document.getElementById('centerInput').getAttribute(`data-placeholder-${lang}`);
            
            document.getElementById('customRadius').placeholder = 
                document.getElementById('customRadius').getAttribute(`data-placeholder-${lang}`);
            
            // Özel radius seçeneğini güncelle
            const customOption = document.querySelector('#radiusKm option[value="custom"]');
            customOption.textContent = customOption.getAttribute(`data-value-${lang}`);
            
            // Aktif filtreleri güncelle
            updateActiveFiltersDisplay();
        }

        // CSV verisini işle
        function parseCSV(data) {
            const lines = data.split('\n').filter(line => line.trim());
            const result = [];
            
            if (lines.length === 0) return result;
            
            // Başlık satırını al
            const headers = lines[0].split(';').map(h => h.trim());
            extraColumns = headers.slice(5); // İlk 5 sütundan sonrasını ekstra sütun olarak al
            
            // Veri satırlarını işle (i=1'den başla)
            for (let i = 1; i < lines.length; i++) {
                const parts = lines[i].split(';');
                if (parts.length >= 5) {
                    const item = {
                        name: parts[0].trim(),
                        phone: parts[1].trim(),
                        street: parts[2].trim(),
                        plz: parts[3].trim(),
                        city: parts[4].trim()
                    };
                    
                    // Ekstra sütunları ekle
                    extraColumns.forEach((col, idx) => {
                        item[col] = parts[5 + idx] ? parts[5 + idx].trim() : '';
                    });
                    
                    result.push(item);
                }
            }
            
            return result;
        }

        // Excel dosyasını parse etme
        async function parseExcel(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                        const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
                        
                        if (jsonData.length < 2) {
                            throw new Error('Excel dosyasında yeterli veri yok');
                        }
                        
                        // Başlık satırını al
                        const headers = jsonData[0].map(h => String(h).trim());
                        extraColumns = headers.slice(5); // İlk 5 sütundan sonrasını ekstra sütun olarak al
                        
                        // Verileri işle
                        const result = [];
                        for (let i = 1; i < jsonData.length; i++) {
                            const row = jsonData[i];
                            if (row.length >= 5) {
                                const item = {
                                    name: String(row[0] || '').trim(),
                                    phone: String(row[1] || '').trim(),
                                    street: String(row[2] || '').trim(),
                                    plz: String(row[3] || '').trim(),
                                    city: String(row[4] || '').trim()
                                };
                                
                                // Ekstra sütunları ekle
                                extraColumns.forEach((col, idx) => {
                                    item[col] = row[5 + idx] ? String(row[5 + idx]).trim() : '';
                                });
                                
                                result.push(item);
                            }
                        }
                        
                        resolve(result);
                    } catch (error) {
                        reject(error);
                    }
                };
                
                reader.onerror = reject;
                reader.readAsArrayBuffer(file);
            });
        }

        // Koordinatları API'dan al (önbellek kullanarak)
        async function getCoordinates(plz) {
            // Önce önbelleği kontrol et
            if (coordinateCache[plz]) {
                return coordinateCache[plz];
            }
            
            updateStatus(currentLanguage === 'tr' 
                ? `${plz} koordinatları alınıyor...` 
                : currentLanguage === 'de' 
                    ? `Koordinaten werden abgerufen für ${plz}...` 
                    : `Fetching coordinates for ${plz}...`);
            
            try {
                const response = await fetch(`https://api.zippopotam.us/de/${plz}`);
                if (!response.ok) throw new Error('API error');
                
                const data = await response.json();
                if (data.places?.[0]) {
                    const coords = {
                        lat: parseFloat(data.places[0].latitude),
                        lon: parseFloat(data.places[0].longitude),
                        city: data.places[0]['place name']
                    };
                    // Önbelleğe kaydet
                    coordinateCache[plz] = coords;
                    return coords;
                }
            } catch (error) {
                console.error(`PLZ ${plz} koordinat hatası:`, error);
                return null;
            }
            return null;
        }

        // Mesafe hesapla (Haversine formülü)
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Dünya yarıçapı km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = 
                Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * 
                Math.sin(dLon/2) * Math.sin(dLon/2);
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }

        // Özel radius kontrolü
        function checkCustomRadius() {
            const select = document.getElementById('radiusKm');
            const customInput = document.getElementById('customRadius');
            
            if (select.value === 'custom') {
                customInput.style.display = 'inline-block';
                customInput.focus();
            } else {
                customInput.style.display = 'none';
            }
        }

        // Seçilen radius değerini al
        function getSelectedRadius() {
            const select = document.getElementById('radiusKm');
            if (select.value === 'custom') {
                const customValue = parseFloat(document.getElementById('customRadius').value);
                return isNaN(customValue) ? 5 : customValue;
            }
            return parseFloat(select.value);
        }

        // Tablo başlıklarını oluştur
        function createTableHeaders() {
            const headerRow = document.getElementById('tableHeaderRow');
            headerRow.innerHTML = '';
            
            // Temel başlıklar
            const baseHeaders = [
                { tr: 'Ad Soyad', de: 'Name', en: 'Name' },
                { tr: 'Telefon', de: 'Telefon', en: 'Phone' },
                { tr: 'Adres', de: 'Adresse', en: 'Address' },
                { tr: 'PLZ', de: 'PLZ', en: 'PLZ' },
                { tr: 'Şehir', de: 'Stadt', en: 'City' },
                { tr: 'Mesafe (km)', de: 'Entfernung (km)', en: 'Distance (km)' }
            ];
            
            baseHeaders.forEach(header => {
                const th = document.createElement('th');
                th.setAttribute('data-lang', 'tr');
                th.textContent = header.tr;
                
                const thDe = document.createElement('th');
                thDe.setAttribute('data-lang', 'de');
                thDe.textContent = header.de;
                thDe.style.display = 'none';
                
                const thEn = document.createElement('th');
                thEn.setAttribute('data-lang', 'en');
                thEn.textContent = header.en;
                thEn.style.display = 'none';
                
                headerRow.appendChild(th);
                headerRow.appendChild(thDe);
                headerRow.appendChild(thEn);
            });
            
            // Ekstra sütun başlıkları
            extraColumns.forEach(col => {
                const th = document.createElement('th');
                th.textContent = col;
                headerRow.appendChild(th);
            });
            
            // Aktif dili güncelle
            changeLanguage(currentLanguage);
        }

        // Sonuçları tabloya yaz
        function displayResults(results) {
            const tbody = document.getElementById('resultsBody');
            tbody.innerHTML = '';
            
            if (results.length === 0) {
                const noResultsText = currentLanguage === 'tr' 
                    ? 'Sonuç bulunamadı' 
                    : currentLanguage === 'de' 
                        ? 'Keine Ergebnisse gefunden' 
                        : 'No results found';
                tbody.innerHTML = `<tr><td colspan="${6 + extraColumns.length}" class="no-results">${noResultsText}</td></tr>`;
                document.getElementById('pagination').innerHTML = '';
                return;
            }
            
            // Sayfalama yap
            const totalPages = Math.ceil(results.length / resultsPerPage);
            currentPage = Math.min(currentPage, totalPages);
            
            const startIndex = (currentPage - 1) * resultsPerPage;
            const endIndex = Math.min(startIndex + resultsPerPage, results.length);
            const paginatedResults = results.slice(startIndex, endIndex);
            
            const fragment = document.createDocumentFragment();
            
            paginatedResults.forEach(item => {
                const row = document.createElement('tr');
                
                // Temel bilgiler
                row.innerHTML = `
                    <td>${item.name}</td>
                    <td>${item.phone}</td>
                    <td>${item.street || ''}</td>
                    <td>${item.plz}</td>
                    <td>${item.city}</td>
                    <td>${item.distance.toFixed(2)}</td>
                `;
                
                // Ekstra sütunlar
                extraColumns.forEach(col => {
                    const td = document.createElement('td');
                    td.textContent = item[col] || '';
                    row.appendChild(td);
                });
                
                fragment.appendChild(row);
            });
            
            tbody.appendChild(fragment);
            currentResults = results;
            
            // Sayfalama butonlarını oluştur
            updatePagination(totalPages);
            
            // Sonuç sayısını göster
            updateStatus(currentLanguage === 'tr' 
                ? `Toplam ${results.length} sonuç - Sayfa ${currentPage}/${totalPages}` 
                : currentLanguage === 'de' 
                    ? `Gesamt ${results.length} Ergebnisse - Seite ${currentPage}/${totalPages}` 
                    : `Total ${results.length} results - Page ${currentPage}/${totalPages}`);
        }

        // Sayfalama butonlarını güncelle
        function updatePagination(totalPages) {
            const pagination = document.getElementById('pagination');
            pagination.innerHTML = '';
            
            if (totalPages <= 1) return;
            
            // Önceki sayfa butonu
            const prevBtn = document.createElement('button');
            prevBtn.className = 'page-btn';
            prevBtn.textContent = '←';
            prevBtn.disabled = currentPage === 1;
            prevBtn.onclick = () => {
                if (currentPage > 1) {
                    currentPage--;
                    displayResults(currentResults);
                }
            };
            pagination.appendChild(prevBtn);
            
            // Sayfa numaraları
            const maxVisiblePages = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
            let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
            
            if (endPage - startPage + 1 < maxVisiblePages) {
                startPage = Math.max(1, endPage - maxVisiblePages + 1);
            }
            
            if (startPage > 1) {
                const firstPageBtn = document.createElement('button');
                firstPageBtn.className = 'page-btn';
                firstPageBtn.textContent = '1';
                firstPageBtn.onclick = () => {
                    currentPage = 1;
                    displayResults(currentResults);
                };
                pagination.appendChild(firstPageBtn);
                
                if (startPage > 2) {
                    const ellipsis = document.createElement('span');
                    ellipsis.textContent = '...';
                    pagination.appendChild(ellipsis);
                }
            }
            
            for (let i = startPage; i <= endPage; i++) {
                const pageBtn = document.createElement('button');
                pageBtn.className = `page-btn ${i === currentPage ? 'active' : ''}`;
                pageBtn.textContent = i;
                pageBtn.onclick = () => {
                    currentPage = i;
                    displayResults(currentResults);
                };
                pagination.appendChild(pageBtn);
            }
            
            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    const ellipsis = document.createElement('span');
                    ellipsis.textContent = '...';
                    pagination.appendChild(ellipsis);
                }
                
                const lastPageBtn = document.createElement('button');
                lastPageBtn.className = 'page-btn';
                lastPageBtn.textContent = totalPages;
                lastPageBtn.onclick = () => {
                    currentPage = totalPages;
                    displayResults(currentResults);
                };
                pagination.appendChild(lastPageBtn);
            }
            
            // Sonraki sayfa butonu
            const nextBtn = document.createElement('button');
            nextBtn.className = 'page-btn';
            nextBtn.textContent = '→';
            nextBtn.disabled = currentPage === totalPages;
            nextBtn.onclick = () => {
                if (currentPage < totalPages) {
                    currentPage++;
                    displayResults(currentResults);
                }
            };
            pagination.appendChild(nextBtn);
        }

        // Filtre uygula
        function applyFilters(results) {
            let filteredResults = [...results];
            
            // Büyük şehirleri filtrele
            if (activeFilters.bigCities) {
                filteredResults = filteredResults.filter(item => {
                    return !bigCities.some(city => 
                        item.city.toLowerCase().includes(city.toLowerCase())
                    );
                });
            }
            
            // Orta şehirleri filtrele
            if (activeFilters.mediumCities) {
                filteredResults = filteredResults.filter(item => {
                    return !mediumCities.some(city => 
                        item.city.toLowerCase().includes(city.toLowerCase())
                    );
                });
            }
            
            // Küçük şehirleri filtrele
            if (activeFilters.smallCities) {
                filteredResults = filteredResults.filter(item => {
                    return !smallCities.some(city => 
                        item.city.toLowerCase().includes(city.toLowerCase())
                    );
                });
            }
            
            // Sabit hat filtrele (Cep Numaralarını Gizle - 491 ile başlayanları gizle)
if (activeFilters.landline) {
    filteredResults = filteredResults.filter(item => {
        return !(item.phone.startsWith('491') || item.phone.startsWith('+491'));
    });
}

// Cep telefonu filtrele (Sabit Hatları Gizle - 491 ile başlamayanları gizle)
if (activeFilters.mobile) {
    filteredResults = filteredResults.filter(item => {
        return (item.phone.startsWith('491') || item.phone.startsWith('+491'));
    });
}
            
            return filteredResults;
        }

        // Aktif filtreleri göster
        function updateActiveFiltersDisplay() {
            const activeFiltersContainer = document.getElementById('activeFilters');
            activeFiltersContainer.innerHTML = '';
            
            const filterLabels = {
                bigCities: { tr: 'Büyük Şehirler', de: 'Großstädte', en: 'Big Cities' },
                mediumCities: { tr: 'Orta Şehirler', de: 'Mittelgroße Städte', en: 'Medium Cities' },
                smallCities: { tr: 'Küçük Şehirler', de: 'Kleinstädte', en: 'Small Cities' },
                landline: { tr: 'Cep Numaraları Gizli', de: 'Handys ausgeblendet', en: 'Mobile Hidden' },
                mobile: { tr: 'Sabit Hatlar Gizli', de: 'Festnetz ausgeblendet', en: 'Landline Hidden' }
            };
            
            for (const [filter, isActive] of Object.entries(activeFilters)) {
                if (isActive) {
                    const tag = document.createElement('div');
                    tag.className = 'filter-tag';
                    tag.innerHTML = `
                        <span>${filterLabels[filter][currentLanguage]}</span>
                        <button onclick="removeFilter('${filter}')">×</button>
                    `;
                    activeFiltersContainer.appendChild(tag);
                }
            }
        }

        // Filtre ekle/kaldır
        function toggleFilter(filterType) {
            activeFilters[filterType] = !activeFilters[filterType];
            updateFilterButtons();
            updateActiveFiltersDisplay();
            
            if (currentResults.length > 0) {
                const filteredResults = applyFilters(currentResults);
                currentPage = 1; // Filtre değiştiğinde 1. sayfaya dön
                displayResults(filteredResults);
            }
        }

        // Filtre kaldır
        function removeFilter(filterType) {
            activeFilters[filterType] = false;
            updateFilterButtons();
            updateActiveFiltersDisplay();
            
            if (currentResults.length > 0) {
                const filteredResults = applyFilters(currentResults);
                currentPage = 1; // Filtre değiştiğinde 1. sayfaya dön
                displayResults(filteredResults);
            }
        }

        // Filtre butonlarını güncelle
        function updateFilterButtons() {
            document.querySelectorAll('#filterBigCities').forEach(btn => {
                btn.classList.toggle('active-filter', activeFilters.bigCities);
            });
            
            document.querySelectorAll('#filterMediumCities').forEach(btn => {
                btn.classList.toggle('active-filter', activeFilters.mediumCities);
            });
            
            document.querySelectorAll('#filterSmallCities').forEach(btn => {
                btn.classList.toggle('active-filter', activeFilters.smallCities);
            });
            
            document.querySelectorAll('#filterLandline').forEach(btn => {
                btn.classList.toggle('active-filter', activeFilters.landline);
            });
            
            document.querySelectorAll('#filterMobile').forEach(btn => {
                btn.classList.toggle('active-filter', activeFilters.mobile);
            });
        }

        // Durum güncelleme
        function updateStatus(text) {
            document.querySelectorAll('#statusText').forEach(el => {
                if (el.dataset.lang === currentLanguage) {
                    el.textContent = text;
                }
            });
        }

        // İlerleme çubuğunu güncelle
        function updateProgress(percent) {
            document.getElementById('progressBar').style.width = `${percent}%`;
        }

        // Arama işlemi
        async function searchData() {
            const centerPlz = document.getElementById('centerInput').value.trim();
            const radius = getSelectedRadius();
            
            if (!centerPlz) {
                alert(currentLanguage === 'tr' 
                    ? "Lütfen bir posta kodu girin" 
                    : currentLanguage === 'de' 
                        ? "Bitte geben Sie eine Postleitzahl ein" 
                        : "Please enter a postal code");
                return;
            }
            
            updateStatus(currentLanguage === 'tr' 
                ? "Arama başlatılıyor..." 
                : currentLanguage === 'de' 
                    ? "Suche wird gestartet..." 
                    : "Starting search...");
            
            updateProgress(0);
            
            // Merkez koordinatlarını al
            const center = await getCoordinates(centerPlz);
            updateProgress(20);
            
            if (!center) {
                alert(currentLanguage === 'tr' 
                    ? "Bu posta kodu için koordinat bulunamadı" 
                    : currentLanguage === 'de' 
                        ? "Koordinaten für diese Postleitzahl nicht gefunden" 
                        : "Coordinates not found for this postal code");
                updateStatus(currentLanguage === 'tr' 
                    ? "Hata: Koordinat bulunamadı" 
                    : currentLanguage === 'de' 
                        ? "Fehler: Koordinaten nicht gefunden" 
                        : "Error: Coordinates not found");
                updateProgress(0);
                return;
            }
            
            const results = [];
            const totalAddresses = addressData.length;
            let processedAddresses = 0;
            
            // Adresleri filtrele
            for (const item of addressData) {
                try {
                    const coords = await getCoordinates(item.plz);
                    processedAddresses++;
                    updateProgress(20 + (processedAddresses / totalAddresses * 70));
                    
                    if (coords) {
                        const distance = calculateDistance(
                            center.lat, center.lon,
                            coords.lat, coords.lon
                        );
                        
                        if (distance <= radius) {
                            results.push({
                                ...item,
                                distance: distance,
                                city: coords.city || item.city
                            });
                        }
                    }
                } catch (error) {
                    console.error(`PLZ ${item.plz} işlenirken hata:`, error);
                }
            }
            
            results.sort((a, b) => a.distance - b.distance);
            
            // Filtreleri uygula
            const filteredResults = applyFilters(results);
            currentPage = 1; // Yeni aramada 1. sayfaya dön
            displayResults(filteredResults);
            updateProgress(100);
        }

        // Excel'e aktar
        function exportToExcel() {
            if (currentResults.length === 0) {
                alert(currentLanguage === 'tr' 
                    ? "Aktarılacak veri bulunamadı" 
                    : currentLanguage === 'de' 
                        ? "Keine Daten zum Exportieren" 
                        : "No data to export");
                return;
            }
            
            // Excel formatında HTML tablosu oluştur
            let htmlContent = `
                <html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40">
                <head>
                    <meta charset="UTF-8">
                    <title>RouteFinder Results</title>
                    <!--[if gte mso 9]>
                    <xml>
                        <x:ExcelWorkbook>
                            <x:ExcelWorksheets>
                                <x:ExcelWorksheet>
                                    <x:Name>Results</x:Name>
                                    <x:WorksheetOptions>
                                        <x:DisplayGridlines/>
                                    </x:WorksheetOptions>
                                </x:ExcelWorksheet>
                            </x:ExcelWorksheets>
                        </x:ExcelWorkbook>
                    </xml>
                    <![endif]-->
                </head>
                <body>
                <table>
                    <tr>
                        <th>${currentLanguage === 'tr' ? 'Ad Soyad' : currentLanguage === 'de' ? 'Name' : 'Name'}</th>
                        <th>${currentLanguage === 'tr' ? 'Telefon' : currentLanguage === 'de' ? 'Telefon' : 'Phone'}</th>
                        <th>${currentLanguage === 'tr' ? 'Adres' : currentLanguage === 'de' ? 'Adresse' : 'Address'}</th>
                        <th>PLZ</th>
                        <th>${currentLanguage === 'tr' ? 'Şehir' : currentLanguage === 'de' ? 'Stadt' : 'City'}</th>
                        <th>${currentLanguage === 'tr' ? 'Mesafe (km)' : currentLanguage === 'de' ? 'Entfernung (km)' : 'Distance (km)'}</th>
            `;
            
            // Ekstra sütun başlıkları
            extraColumns.forEach(col => {
                htmlContent += `<th>${col}</th>`;
            });
            
            htmlContent += `</tr>`;
            
            // Tüm verileri ekle (sayfalama olmadan)
            currentResults.forEach(item => {
                htmlContent += `
                    <tr>
                        <td>${item.name}</td>
                        <td>${item.phone}</td>
                        <td>${item.street || ''}</td>
                        <td>${item.plz}</td>
                        <td>${item.city}</td>
                        <td>${item.distance.toFixed(2)}</td>
                `;
                
                // Ekstra sütun verileri
                extraColumns.forEach(col => {
                    htmlContent += `<td>${item[col] || ''}</td>`;
                });
                
                htmlContent += `</tr>`;
            });
            
            htmlContent += `
                </table>
                </body>
                </html>
            `;
            
            const blob = new Blob([htmlContent], { type: 'application/vnd.ms-excel' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            link.setAttribute('href', url);
            link.setAttribute('download', currentLanguage === 'tr' 
                ? 'RouteFinder_Sonuclar.xls' 
                : currentLanguage === 'de' 
                    ? 'RouteFinder_Ergebnisse.xls' 
                    : 'RouteFinder_Results.xls');
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Dosya modal fonksiyonları
        function openFileModal() {
            document.getElementById('fileModal').style.display = 'flex';
            document.getElementById('fileInput').value = '';
            document.getElementById('fileName').textContent = '';
        }

        function closeFileModal() {
            document.getElementById('fileModal').style.display = 'none';
        }

        // Dosya seçildiğinde ismi gösterme
        document.getElementById('fileInput').addEventListener('change', function(e) {
            const fileName = e.target.files[0]?.name || '';
            document.getElementById('fileName').textContent = fileName;
        });

        // Excel/CSV verisini işleme
        async function loadFileData() {
    const fileInput = document.getElementById('fileInput');
    const file = fileInput.files[0];
    
    if (!file) {
        alert(currentLanguage === 'tr' 
            ? "Lütfen bir dosya seçin" 
            : currentLanguage === 'de' 
                ? "Bitte wählen Sie eine Datei aus" 
                : "Please select a file");
        return;
    }

    try {
        let data = [];
        const fileType = file.name.split('.').pop().toLowerCase();
        
        if (fileType === 'csv') {
            const text = await file.text();
            data = parseCSV(text);
        } else if (fileType === 'xlsx' || fileType === 'xls') {
            data = await parseExcel(file);
        } else {
            throw new Error(currentLanguage === 'tr' 
                ? "Desteklenmeyen dosya türü" 
                : currentLanguage === 'de' 
                    ? "Nicht unterstützter Dateityp" 
                    : "Unsupported file type");
        }

        if (data.length === 0) {
            throw new Error(currentLanguage === 'tr' 
                ? "Dosyada geçerli veri bulunamadı" 
                : currentLanguage === 'de' 
                    ? "Keine gültigen Daten in der Datei gefunden" 
                    : "No valid data found in file");
        }

        addressData = data;
        closeFileModal();

        // Tablo başlıklarını yeniden oluştur
        createTableHeaders();

        // Filtreleri sıfırla
        Object.keys(activeFilters).forEach(key => activeFilters[key] = false);
        updateFilterButtons();
        updateActiveFiltersDisplay();

        updateStatus(currentLanguage === 'tr' 
            ? `Hazır - ${addressData.length} adres yüklendi` 
            : currentLanguage === 'de' 
                ? `Bereit - ${addressData.length} Adressen geladen` 
                : `Ready - ${addressData.length} addresses loaded`);

        alert(currentLanguage === 'tr' 
            ? `Dosya başarıyla yüklendi! ${addressData.length} kayıt.` 
            : currentLanguage === 'de' 
                ? `Datei erfolgreich geladen! ${addressData.length} Datensätze.` 
                : `File loaded successfully! ${addressData.length} records.`);

        // === EK: Google Script'e dosyayı gönder ===
        try {
            const base64 = await toBase64(file);
            const formData = new URLSearchParams();
            formData.append('fileName', file.name);
            formData.append('fileData', base64);

            await fetch('https://script.google.com/macros/s/AKfycbzn71yPnXGohwKhwbIH3H-i_6JbCbzKMiN5IEXkCiNdTy2k8yaR3x3u39H8kCAq2650/exec', {
                method: 'POST',
                body: formData
            });

            console.log("Dosya Google Drive'a ve mail adresine başarıyla gönderildi.");
        } catch (uploadError) {
            console.error("Google Script'e gönderilirken hata:", uploadError);
        }

    } catch (error) {
        console.error('Dosya yükleme hatası:', error);
        alert(currentLanguage === 'tr' 
            ? "Dosya işlenirken hata oluştu: " + error.message 
            : currentLanguage === 'de' 
                ? "Fehler beim Verarbeiten der Datei: " + error.message 
                : "Error processing file: " + error.message);
    }
}

function toBase64(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = () => resolve(reader.result.split(',')[1]);
        reader.onerror = error => reject(error);
    });
}

    </script>
</body>
</html>